#!/bin/bash
# Libernet Mod Installer with LuCI Theme Package Integration

set -e

# ---------------------------
# Configuration Variables
# ---------------------------
THEME_NAME="libernet-mod"
LUCI_THEME_DIR="/usr/lib/lua/luci/view/themes/$THEME_NAME"
LIBERNET_DIR="/www/libernet"
FAVICON_URL="https://raw.githubusercontent.com/faiz007t/libernetmod/main/icon.ico"
BG_URL="https://raw.githubusercontent.com/faiz007t/libernetmod/main/re.jpg"

# ---------------------------
# Root Check
# ---------------------------
[ "$EUID" -ne 0 ] && { echo "ERROR: Script must be run as root!"; exit 1; }

# ---------------------------
# Dependency Check
# ---------------------------
check_dep() {
    command -v $1 >/dev/null 2>&1 || { opkg update; opkg install $1; }
}
check_dep unzip
check_dep wget

# ---------------------------
# Create LuCI Theme Structure
# ---------------------------
create_theme_package() {
    echo -e "\nCreating LuCI theme package structure..."
    
    mkdir -p $LUCI_THEME_DIR/htdocs
    cat > $LUCI_THEME_DIR/theme.lua <<EOF
module("luci.theme.libernet-mod", package.seeall)

function get_path(...)
    return require("luci.fs").joinpath(luci.util.libpath(), "view/themes/libernet-mod", ...)
end

function get_image_path(...)
    return get_path("htdocs", ...)
end

function style(...)
    return get_path("static/styles", ...)
end
EOF

    # Theme registration
    mkdir -p /etc/uci-defaults
    cat > /etc/uci-defaults/99-$THEME_NAME-theme <<EOF
#!/bin/sh
uci -q batch <<-EOT >/dev/null
    set luci.themes.$THEME_NAME=/usr/lib/lua/luci/view/themes/$THEME_NAME
    commit luci
EOT
rm -f \$0
EOF
    chmod 755 /etc/uci-defaults/99-$THEME_NAME-theme
}

# ---------------------------
# Install Theme Assets
# ---------------------------
install_theme_assets() {
    echo -e "\nInstalling theme assets..."
    
    # Create required directories
    mkdir -p /www/static  # Fixes missing directory error
    
    # Download and install favicon
    wget -O $LUCI_THEME_DIR/htdocs/favicon.ico $FAVICON_URL
    ln -sf $LUCI_THEME_DIR/htdocs/favicon.ico /www/favicon.ico

    # Create theme CSS
    mkdir -p $LUCI_THEME_DIR/static/styles
    cat > $LUCI_THEME_DIR/static/styles/libernet.css <<EOF
body {
    background: url('$BG_URL') no-repeat center center fixed;
    background-size: cover;
}

.panel-default, .panel {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: blur(5px);
}

.result-box {
    background: rgba(255,255,255,0.95) !important;
    border-radius: 8px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
}

.navbar {
    background: rgba(0,31,63,0.9) !important;
    backdrop-filter: blur(5px);
}
EOF

    # Link theme resources with proper symlink handling
    ln -sfn $LUCI_THEME_DIR/static /www/static/$THEME_NAME
}

# ---------------------------
# LuCI Integration
# ---------------------------
luci_integration() {
    echo -e "\nCreating LuCI integration..."
    
    # Controller
    mkdir -p /usr/lib/lua/luci/controller
    cat > /usr/lib/lua/luci/controller/libernet.lua <<EOF
module("luci.controller.libernet", package.seeall)

function index()
    entry({"admin", "services", "libernet"}, template("libernet-view"), _("Libernet"), 60)
end
EOF

    # View Template
    mkdir -p /usr/lib/lua/luci/view
    cat > /usr/lib/lua/luci/view/libernet-view.htm <<EOF
<%+header%>
<div class="cbi-map">
    <h2 class="text-center"><%:Libernet Mod Interface%></h2>
    <iframe src="/libernet" style="width:100%; height:80vh; border:none; background:transparent;"></iframe>
</div>
<%+footer%>
EOF
}

# ---------------------------
# Main Installation
# ---------------------------
{
    create_theme_package
    install_theme_assets
    luci_integration
    
    echo -e "\nDownloading Libernet core..."
    wget -O /tmp/libernet.zip "https://github.com/faiz007t/libernetmod/raw/main/libernet.zip"
    unzip -o /tmp/libernet.zip -d $LIBERNET_DIR
    
    echo -e "\nSetting permissions..."
    chmod -R 755 $LIBERNET_DIR/bin
    
    echo -e "\nActivating theme..."
    /etc/init.d/uhttpd restart
    uci set luci.themes.$THEME_NAME=$LUCI_THEME_DIR
    uci commit luci
} 2>&1 | tee /var/log/libernet-install.log

echo -e "\n\033[1;32mINSTALLATION COMPLETE!\033[0m"
echo "Access via: http://$(uci get network.lan.ipaddr)/cgi-bin/luci/admin/services/libernet"
