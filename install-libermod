#!/bin/bash

set -e

# Check for root permissions
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root" 
   exit 1
fi

clear
echo -e "##############################################"
echo -e "#       Libernet Mod v1.5.4 Installer        #"     
echo -e "##############################################\n"
sleep 1
echo -e "Sebelum Install Libernet Mod Pastikan Anda Sudah Install Libernet by Lutfa Ilham\n"
sleep 1
echo -e "List New Update and Remove:"
echo -e "- Add Ping"
echo -e "- Add Refresh Info Button"
echo -e "- Add Page in List Services"
echo -e "- Remove Login Page"
echo -e "- Remove Speedtest Page"
echo -e "- Remove TX|RX"
echo -e "- Change Theme Color"
echo -e "- Change Background Image\n"
sleep 3
echo -e "Waiting for Proses Install Libernet Mod...\n"
sleep 2

# === Preserve all config modes ===
if [ -d /root/libernet/data/config ]; then
    echo "Backing up all Libernet mode configs..."
    cp -r /root/libernet/data/config /root/libernet/data/config_backup_$(date +%s)
fi

sleep 2

# Download modified files (these should NOT overwrite mode config files)
echo "Downloading modified files..."
{
    wget -O /www/libernet/system.php --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/system.php
    wget -O /www/libernet/navbar.php --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/navbar.php
    wget -O /www/libernet/index.php --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/index.php
    wget -O /www/libernet/head.php --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/head.php
    wget -O /www/libernet/footer.php --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/footer.php
    wget -O /www/libernet/about.php --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/about.php
    wget -O /www/libernet/img/re.jpg --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/re.jpg
    wget -O /www/libernet/assets/img/backgrounds/re.jpg --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/re.jpg
    wget -O /www/libernet/lib/vendor/bootstrap/css/bootstrap.min.css --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/bootstrap.min.css
    wget -O /root/libernet/bin/ping-loop.sh --no-check-certificate https://raw.githubusercontent.com/faiz007t/libernetmod/main/ping-loop.sh
} &> log-install.txt

# Add LuCI integration
{
cat <<'EOF' > /usr/lib/lua/luci/view/libernet.htm
<!DOCTYPE html>
<html>
<head>
  <title>Libernet Mod | Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #222;
      touch-action: manipulation;
    }
    #libernet {
      width: 100vw;
      height: 100vh;
      border: none;
      display: block;
    }
    #luci-back {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      border: none;
      border-radius: 50%;
      padding: 8px;
      width: 48px;
      height: 48px;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    #luci-back svg {
      width: 28px;
      height: 28px;
      fill: white;
    }
    @media (max-width: 768px) {
      #luci-back {
        width: 44px;
        height: 44px;
        top: 8px;
        left: 8px;
      }
      #luci-back svg {
        width: 24px;
        height: 24px;
      }
    }
  </style>
</head>
<body>
  <button id="luci-back"
          role="button"
          aria-label="Return to LuCI interface"
          onclick="window.location.href='http://' + window.location.hostname + '/cgi-bin/luci/'">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
    </svg>
  </button>

  <iframe id="libernet" scrolling="auto"></iframe>

  <script>
    document.getElementById("libernet").src = "http://" + window.location.hostname + "/libernet";
  </script>
</body>
</html>
EOF
} &>> log-install.txt

# Make sure ping-loop.sh is executable
chmod +x /root/libernet/bin/ping-loop.sh

rm -f /www/libernet.zip

# Remove the installer itself (if desired)
rm -f "$0"

echo -e "\nProses Pemasangan Libernet Mod Selesai !!!"
echo -e "\nNOTE: Pastikan clear dulu cache browser sebelum masuk ke Libernet Mod\n"
