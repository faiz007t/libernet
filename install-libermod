#!/bin/bash
# Libernet Mod Installer with LuCI Integration
# Combined script with enhanced error handling and styling

set -e

# ---------------------------
# Configuration Variables
# ---------------------------
LUCI_CONTROLLER="/usr/lib/lua/luci/controller/libernet.lua"
LUCI_VIEW="/usr/lib/lua/luci/view/libernet.htm"
LIBERNET_DIR="/www/libernet"
BACKUP_DIR="/www/libernet_backup_$(date +%s)"
GITHUB_BASE="https://raw.githubusercontent.com/faiz007t/libernetmod/main"

# ---------------------------
# Root Check
# ---------------------------
if [[ "$EUID" -ne 0 ]]; then
   echo "ERROR: Script harus dijalankan sebagai root!" 
   exit 1
fi

# ---------------------------
# Initialization
# ---------------------------
clear
echo -e "##############################################"
echo -e "#     Libernet Mod v1.5.4 Installer Pro      #"
echo -e "##############################################\n"
echo -e "Pastikan sudah install Libernet dasar oleh Lutfa Ilham!\n"
sleep 2

# ---------------------------
# Dependency Check
# ---------------------------
check_dependency() {
    if ! command -v $1 &> /dev/null; then
        echo "Menginstall dependency: $1..."
        opkg update && opkg install $1
    fi
}

check_dependency unzip
check_dependency wget

# ---------------------------
# Backup Existing Installation
# ---------------------------
if [ -d "$LIBERNET_DIR" ]; then
    echo -e "\nMembuat backup instalasi sebelumnya..."
    cp -r "$LIBERNET_DIR" "$BACKUP_DIR"
    echo -e "Backup tersimpan di: $BACKUP_DIR\n"
fi

# ---------------------------
# Main Installation
# ---------------------------
echo -e "\nMemulai proses instalasi Libernet Mod..."
{
    echo -e "\nMengunduh paket utama..."
    wget -O "/www/libernet.zip" --no-check-certificate "${GITHUB_BASE}/libernet.zip"
    
    echo -e "\nMengekstrak file..."
    unzip -o "/www/libernet.zip" -d "/www"
    
    echo -e "\nMemasang file modifikasi:"
    declare -A MOD_FILES=(
        ["system.php"]="system.php"
        ["navbar.php"]="navbar.php" 
        ["index.php"]="index.php"
        ["head.php"]="head.php"
        ["footer.php"]="footer.php"
        ["config.php"]="config.php"
        ["about.php"]="about.php"
        ["bootstrap.min.css"]="bootstrap.min.css"
        ["ping-loop.sh"]="ping-loop.sh"
    )

    for file in "${!MOD_FILES[@]}"; do
        echo " - ${MOD_FILES[$file]}"
        wget -O "${LIBERNET_DIR}/${MOD_FILES[$file]}" --no-check-certificate "${GITHUB_BASE}/${file}"
    done

    echo -e "\nMengatur permission..."
    chmod +x "/root/libernet/bin/ping-loop.sh"
} 2>&1 | tee install.log

# ---------------------------
# LuCI Integration
# ---------------------------
echo -e "\nMembuat integrasi LuCI..."
cat > $LUCI_CONTROLLER <<'EOF'
module("luci.controller.libernet", package.seeall)

function index()
    entry({"admin", "services", "libernet"}, template("libernet"), _("Libernet"), 55).leaf = true
end
EOF

cat > $LUCI_VIEW <<'EOF'
<!DOCTYPE html>
<html>
<head>
  <title>Libernet Mod | Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #222;
      touch-action: manipulation;
    }
    #libernet {
      width: 100vw;
      height: 100vh;
      border: none;
      display: block;
    }
    #luci-back {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      border: none;
      border-radius: 50%;
      padding: 8px;
      width: 48px;
      height: 48px;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    #luci-back svg {
      width: 28px;
      height: 28px;
      fill: white;
    }
    @media (max-width: 768px) {
      #luci-back {
        width: 44px;
        height: 44px;
        top: 8px;
        left: 8px;
      }
      #luci-back svg {
        width: 24px;
        height: 24px;
      }
    }
  </style>
</head>
<body>
  <button id="luci-back"
          role="button"
          aria-label="Return to LuCI interface"
          onclick="window.location.href='http://' + window.location.hostname + '/cgi-bin/luci/'">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
    </svg>
  </button>

  <iframe id="libernet" scrolling="auto"></iframe>

  <script>
    document.getElementById("libernet").src = "http://" + window.location.hostname + "/libernet";
  </script>
</body>
</html>
EOF

# ---------------------------
# Final Configuration
# ---------------------------
echo -e "\nMengatur permission file..."
chmod 644 $LUCI_CONTROLLER
chmod 644 $LUCI_VIEW

echo -e "\nMerestart layanan web..."
/etc/init.d/uhttpd restart

# ---------------------------
# Cleanup
# ---------------------------
echo -e "\nMembersihkan file instalasi..."
rm -f "/www/libernet.zip"
rm -f "$0"

# ---------------------------
# Completion Message
# ---------------------------
echo -e "\n\033[1;32mINSTALASI BERHASIL!\033[0m"
echo -e "Akses Libernet Mod melalui:"
echo -e "1. Web Interface: \033[4mhttp://$(uci get network.lan.ipaddr)/libernet\033[0m"
echo -e "2. LuCI Interface: Menu Services -> Libernet"
echo -e "\nJangan lupa untuk:"
echo -e "- Membersihkan cache browser"
echo -e "- Memeriksa log instalasi di: install.log"
echo -e "- Backup konfigurasi penting\n"
